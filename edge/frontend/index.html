<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>MQTT Map + Camera</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    html, body { height: 100%; margin: 0; }

    /* Split screen layout */
    .layout {
      height: 100%;
      display: flex;
    }

    /* Map smaller (left) */
    #map {
      flex: 0 0 60%;   /* <-- change to 50% / 40% if you want */
      height: 100%;
    }

    /* Camera panel (right) */
    .camera {
      flex: 1;
      height: 100%;
      background: #111;
      display: flex;
      flex-direction: column;
      min-width: 320px;
    }

    .cameraHeader {
      color: white;
      font-family: sans-serif;
      padding: 10px 12px;
      font-size: 14px;
      background: rgba(0,0,0,0.6);
    }

    .cameraBody {
      position: relative;
      flex: 1;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Try iframe first (works for many http streams/pages) */
    #camFrame {
      width: 100%;
      height: 100%;
      border: 0;
      background: black;
    }

    /* MJPEG fallback (common for /cam endpoints) */
    #camImg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none; /* shown only if iframe fails */
    }

    /* HUD stays on top of the map */
    .hud {
      position: absolute; top: 10px; left: 10px;
      background: white; padding: 8px;
      font-family: sans-serif; z-index: 1000;
      border-radius: 6px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    /* Make sure HUD overlays only the map area */
    .mapWrap {
      position: relative;
      height: 100%;
      flex: 0 0 60%;
    }
    .mapWrap #map { width: 100%; }
  </style>
</head>
<body>

<div class="layout">
  <div class="mapWrap">
    <div id="map"></div>
    <div class="hud">
      MQTT: <span id="status">disconnected</span><br>
      Last: <span id="last">-</span>
    </div>
  </div>

  <div class="camera">
    <div class="cameraHeader">
      Live Camera: <span id="camStatus">loadingâ€¦</span>
    </div>
    <div class="cameraBody">
      <iframe id="camFrame" title="Live camera"></iframe>
      <img id="camImg" alt="Live camera feed"/>
    </div>
  </div>
</div>

<script>
  const PI_IP = "192.168.2.13";
  const TOPIC = "iot/#";

  // ---- Map ----
  const map = L.map("map").setView([37.98, 23.73], 13);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);
  const marker = L.marker([37.98, 23.73]).addTo(map);

  const statusEl = document.getElementById("status");
  const lastEl = document.getElementById("last");

  const client = mqtt.connect(`ws://${PI_IP}:9001`);

  client.on("connect", () => {
    statusEl.textContent = "connected";
    client.subscribe(TOPIC);
  });

  client.on("close", () => statusEl.textContent = "disconnected");
  client.on("error", () => statusEl.textContent = "error");

  client.on("message", (topic, msg) => {
    const txt = msg.toString();
    lastEl.textContent = txt;

    try {
      const data = JSON.parse(txt);
      if (typeof data.lat === "number" && typeof data.lon === "number") {
        marker.setLatLng([data.lat, data.lon]);
        map.panTo([data.lat, data.lon], { animate: true });
      }
    } catch {}
  });

  // ---- Camera ----
  const camUrl = `http://${PI_IP}:8888/cam`;
  const camFrame = document.getElementById("camFrame");
  const camImg = document.getElementById("camImg");
  const camStatus = document.getElementById("camStatus");

  // Try iframe first
  camFrame.src = camUrl;

  // If iframe doesn't load (common due to headers/content-type), fallback to <img> (MJPEG)
  let iframeOk = false;
  camFrame.addEventListener("load", () => {
    iframeOk = true;
    camStatus.textContent = "live";
  });

  // After 2 seconds, if iframe didn't load, switch to img
  setTimeout(() => {
    if (!iframeOk) {
      camFrame.style.display = "none";
      camImg.style.display = "block";
      camImg.src = camUrl;
      camStatus.textContent = "live (mjpeg/img)";
    }
  }, 2000);

  // Leaflet needs invalidateSize after container layout loads
  setTimeout(() => map.invalidateSize(), 200);
</script>

</body>
</html>
